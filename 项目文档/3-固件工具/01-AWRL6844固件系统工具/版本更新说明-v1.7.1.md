# 🎉 v1.7.1 版本更新说明

**发布日期**: 2025-12-19  
**版本号**: v1.7.1  
**构建日期**: 2025-12-19

---

## 🔧 修复内容

### 1️⃣ **彻底修复进度条显示问题** ✅

**问题描述**：
- v1.6.9的进度条修复没有生效
- 使用delete_last_line()删除方式不够精确
- 导致进度条仍然多行显示

**新解决方案**：
采用**Text widget的mark标记**技术实现真正的单行更新

**技术实现**：
```python
# 旧方案（有问题）
if progress:
    delete_last_line()  # 删除整行，不够精确
    log(new_progress)

# 新方案（完美）
if progress:
    if mark is None:
        log(new_progress)
        mark = get_last_line_start()  # 记录位置
    else:
        update_line_at_mark(mark, new_progress)  # 精确替换
```

**核心方法**：
1. `get_last_line_start()` - 获取最后一行的起始位置
2. `update_line_at_mark(mark, text)` - 在mark位置精确替换内容

**修复范围**：
- ✅ 完整烧录 - SBL部分
- ✅ 完整烧录 - App部分  
- ✅ 仅SBL烧录
- ✅ 仅App烧录

所有4个烧录进程的进度条现在都会**在同一行原地更新**！

---

### 2️⃣ **解决"SBL烧录成功但检测不到"问题** 💡

根据知识库分析，找出了用户困惑的根本原因：**SOP模式未切换**

**添加的提示**：

#### SBL烧录完成后（仅SBL）
```
✅ SBL已成功烧录到Flash

⚠️ 重要：SBL还未运行！

📌 启动SBL的步骤：
   1. 切换SOP开关到 [0 1]（运行模式）
      S8 = OFF, S7 = ON
   
   2. 按RESET按钮启动设备

💡 现在可以：
   • 启动SBL验证烧录成功
   • 或继续烧录App固件
```

#### SBL烧录完成后（完整烧录）
```
✅ SBL已成功烧录到Flash

⚠️ 接下来请准备烧录App：

📌 硬件操作：
   • 保持SOP开关在烧录模式 [0 0]
   • 拔插USB或按RESET按钮

💡 如果不烧录App：
   1. 切换SOP开关到 [0 1]（运行模式）
   2. 按RESET按钮启动SBL

点击确定继续烧录App...
```

#### App烧录完成后
```
✅ App已成功烧录到Flash

📌 运行App的步骤：
   1. 切换SOP开关到 [0 1]（运行模式）
      S8 = OFF, S7 = ON
   
   2. 按RESET按钮启动设备
   
   3. 打开串口监视查看输出
      COM4 - 115200 8N1
```

**用户价值**：
- ✅ 清晰的硬件操作指导
- ✅ 避免"烧录成功但检测不到"的困惑
- ✅ 新手友好，减少支持成本

---

## 📊 技术细节

### Mark标记原理

```python
def get_last_line_start(self):
    """获取最后一行的起始位置"""
    return log_text.index("end-2l linestart")

def update_line_at_mark(self, mark_pos, new_text):
    """在指定位置更新内容（不删除整行）"""
    log_text.config(state=tk.NORMAL)
    
    # 只删除mark位置到行尾的内容
    log_text.delete(mark_pos, f"{mark_pos} lineend")
    
    # 插入新内容
    log_text.insert(mark_pos, new_text.rstrip('\n'))
    
    # 自动滚动
    log_text.see(tk.END)
    log_text.config(state=tk.DISABLED)
```

### 进度行检测逻辑

```python
is_progress = ('%' in line and 
             ('Erasing' in line or 'Writing' in line or 
              'Progress' in line or line.strip().startswith('[')))
```

**匹配的进度行示例**：
```
Erasing 10.00%
Writing 50.00%
Progress: 75%
[=========>          ] 90%
```

---

## 🎯 测试建议

### 测试场景1：完整烧录
1. 点击"完整烧录(SBL+App)"
2. 观察SBL烧录进度条（应该单行更新）
3. 确认SBL完成提示（提示保持SOP在[0 0]）
4. 拔插USB继续App烧录
5. 观察App烧录进度条（应该单行更新）
6. 确认App完成提示（提示切换SOP到[0 1]）

### 测试场景2：仅SBL
1. 点击"仅SBL"
2. 观察进度条（应该单行更新）
3. 确认完成提示（提示如何启动SBL）

### 测试场景3：仅App
1. 点击"仅App"
2. 观察进度条（应该单行更新）
3. 确认完成提示（提示如何运行App）

### 预期结果
- ✅ 进度条在同一行原地更新，不产生多行
- ✅ 进度显示流畅，无闪烁
- ✅ 每个阶段都有清晰的操作提示
- ✅ 用户知道下一步该做什么

---

## 🐛 已知问题

无

---

## 📝 后续计划

1. **v1.7.2**: 添加串口自动重连功能
2. **v1.7.3**: 增加固件验证功能（读取Flash内容）
3. **v1.8.0**: 集成TI SDK示例固件库

---

## 🔗 相关文档

- [SBL烧录后检测不到的原因分析](../2-开发记录/2025-12-19/2025-12-19_SBL烧录后检测不到的原因分析.md)
- [SOP模式配置说明](../2-开发记录/2025-12-12/2025-12-12_SOP配置修正说明.md)
- [操作指南](./操作指南.md)

---

**版本对比**：

| 版本 | 进度条 | SOP提示 | 状态 |
|-----|--------|---------|------|
| v1.6.9 | ❌ 多行 | ❌ 无 | 已弃用 |
| v1.7.0 | ❌ 多行 | ❌ 无 | 已弃用 |
| v1.7.1 | ✅ 单行 | ✅ 完整 | **当前版本** |

---

**更新人员**: AI Assistant  
**测试状态**: 待用户测试  
**文档状态**: ✅ 完成
