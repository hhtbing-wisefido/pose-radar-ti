# 📊 配置命令组合测试结果分析

**日期**: 2026-01-15
**测试类型**: 配置命令注释组合测试
**测试目的**: 找出导致sensorStart失败的根本原因

---

## 🎯 测试结果汇总

| 测试# | factoryCalibCfg | antGeometryBoard | adcDataSource | adcLogging | 错误码               | 错误信息                                        |
| ----- | --------------- | ---------------- | ------------- | ---------- | -------------------- | ----------------------------------------------- |
| 1     | ❌ 注释         | ❌ 注释          | ✅ 启用       | ❌ 注释    | **-1**         | **Antenna geometry is not fully defined** |
| 2     | ✅ 启用         | ❌ 注释          | ✅ 启用       | ❌ 注释    | **-1**         | **Antenna geometry is not fully defined** |
| 3     | ❌ 注释         | ❌ 注释          | ✅ 启用       | ✅ 启用    | **-1**         | **Antenna geometry is not fully defined** |
| 4     | ✅ 启用         | ✅ 启用          | ✅ 启用       | ❌ 注释    | **-203621554** | **Failed to start sensor**                |
| 5     | ✅ 启用         | ✅ 启用          | ✅ 启用       | ✅ 启用    | **-203621554** | **Failed to start sensor**                |
| 6     | ✅ 启用         | ✅ 启用          | ❌ 注释       | ✅ 启用    | **-203621554** | **Failed to start sensor**                |
| 7     | ❌ 注释         | ✅ 启用          | ✅ 启用       | ❌ 注释    | **-203621554** | **Failed to start sensor**                |
| 8     | ❌ 注释         | ✅ 启用          | ✅ 启用       | ✅ 启用    | **-203621554** | **Failed to start sensor**                |
| 9     | ❌ 注释         | ❌ 注释          | ❌ 注释       | ❌ 注释    | **-1**         | **Antenna geometry is not fully defined** |
| 10    | ❌ 注释         | ✅ 启用          | ❌ 注释       | ❌ 注释    | **-1**         | **Antenna geometry is not fully defined** |
| 11    | ✅ 启用         | ❌ 注释          | ❌ 注释       | ❌ 注释    | **-1**         | **Antenna geometry is not fully defined** |
| 12    | ✅ 启用         | ✅ 启用          | ❌ 注释       | ❌ 注释    | **-1**         | **Antenna geometry is not fully defined** |

---

## 🔍 关键发现

### 发现1️⃣：两种错误模式

#### 错误A：`Error: Antenna geometry is not fully defined` (错误码: -1)

**触发条件**：

- ❌ **antGeometryBoard未启用** OR
- ❌ **adcDataSource未启用**

**测试验证**：

```
测试1: antGeometry=注释, adcDataSource=启用  → Error -1 ✓
测试2: antGeometry=注释, adcDataSource=启用  → Error -1 ✓
测试3: antGeometry=注释, adcDataSource=启用  → Error -1 ✓
测试9: antGeometry=注释, adcDataSource=注释 → Error -1 ✓
测试10: antGeometry=启用, adcDataSource=注释 → Error -1 ✓
测试11: antGeometry=注释, adcDataSource=注释 → Error -1 ✓
测试12: antGeometry=启用, adcDataSource=注释 → Error -1 ✓
```

**结论**：

- 🔴 **缺少 antGeometryBoard 时必然报错 "Antenna geometry is not fully defined"**
- 🔴 **adcDataSource 的存在不影响该错误**

#### 错误B：`Error: Failed to start sensor [-203621554]`

**触发条件**：

- ✅ **antGeometryBoard已启用** AND
- ✅ **adcDataSource已启用**

**测试验证**：

```
测试4: antGeometry=启用, adcDataSource=启用  → Error -203621554 ✓
测试5: antGeometry=启用, adcDataSource=启用  → Error -203621554 ✓
测试6: antGeometry=启用, adcDataSource=注释 → Error -203621554 ✓
测试7: antGeometry=启用, adcDataSource=启用  → Error -203621554 ✓
测试8: antGeometry=启用, adcDataSource=启用  → Error -203621554 ✓
```

**特殊发现**：

- ⚠️ **测试6：antGeometry=启用, adcDataSource=注释 → 仍然 -203621554**
- 这说明问题不在 adcDataSource！

**结论**：

- 🔴 **有 antGeometryBoard 但 factoryCalibCfg 配置错误 → -203621554**
- 🔴 **factoryCalibCfg 的参数问题才是真正原因**

---

## 🎯 核心结论

### 结论1：antGeometryBoard 是必需的

```
❌ 错误理解：antGeometryBoard 是可选的
✅ 正确理解：antGeometryBoard 是强制必需的
```

**证据**：

- 所有不包含 antGeometryBoard 的测试都报错 "Antenna geometry is not fully defined"
- SDK要求必须定义天线几何配置

### 结论2：adcDataSource 不是错误根源

```
❌ 错误猜测：adcDataSource 导致 -203621554
✅ 测试证明：有无 adcDataSource 都会报 -203621554（当有 antGeometryBoard 时）
```

**证据**：

- 测试4/5/7/8：有 adcDataSource → -203621554
- 测试6：无 adcDataSource → 仍然 -203621554

### 结论3：factoryCalibCfg 参数错误是真正原因

```
✅ 真正原因：factoryCalibCfg 1 0 44 2 0x1ff000 参数无效
```

**证据**：

- 测试4/5/6：有 factoryCalibCfg → -203621554
- 测试7/8：无 factoryCalibCfg → 仍然 -203621554（因为第9轮代码会用0值调用）

---

## 🔧 修复方案

### 方案A：完全禁用工厂校准（推荐用于开发测试）

**修改配置文件**：

```properties
sensorStop 0
channelCfg 153 255 0
apllFreqShiftEn 0
chirpComnCfg 8 0 0 256 1 13.1 3
chirpTimingCfg 6 63 0 160 58
adcDataDitherCfg 1
frameCfg 64 0 1358 1 100 0
gpAdcMeasConfig 0 0
guiMonitor 1 1 0 0 0 1
cfarProcCfg 0 2 8 4 3 0 9.0 0
cfarProcCfg 1 2 4 2 2 1 9.0 0
cfarFovCfg 0 0.25 9.0
cfarFovCfg 1 -20.16 20.16
aoaProcCfg 64 64
aoaFovCfg -60 60 -60 60
clutterRemoval 0
% 完全禁用工厂校准（开发测试用）
% factoryCalibCfg 1 0 44 2 0x1ff000
runtimeCalibCfg 1
antGeometryBoard xWRL6844EVM  ← ✅ 必需！
lowPowerCfg 1
sensorStart 0 0 0 0
```

**同时修改代码**（radar_control.c）：

```c
if (saveRestoreMode == 1)
{
    /* 🟢 强制跳过工厂校准（开发模式）*/
    DebugP_log("RadarControl: Factory calibration disabled (development mode)\r\n");
    /* 不调用 MMWave_factoryCalib() */
}
```

### 方案B：使用正确的工厂校准参数

**查找正确参数**：

1. 查阅 AWRL6844 数据手册的工厂校准章节
2. 参考 SDK 示例中的实际参数
3. 咨询 TI 技术支持

**可能的正确参数**（需验证）：

```properties
% 场景1：第一次使用（保存校准数据）
factoryCalibCfg 1 0 44 2 0x1ff000

% 场景2：后续使用（恢复校准数据）
factoryCalibCfg 0 1 44 2 0x1ff000
```

---

## 📋 待办事项（按优先级）

### 🔴 优先级1：立即修复

- [ ] **修复 radar_control.c：强制跳过工厂校准**
  - 修改位置：Line 452-502
  - 改为：直接跳过，不检查 flashOffset
  - 理由：参数无效，先让雷达能启动

### 🟡 优先级2：验证天线配置

- [ ] **确认 antGeometryBoard xWRL6844EVM 是否足够**
  - 可能需要额外的天线几何定义命令
  - 查阅 SDK 文档确认完整的天线配置流程

### 🟢 优先级3：后续优化

- [ ] **研究正确的工厂校准参数**
  - 查阅 AWRL6844 校准文档
  - 测试不同参数组合
  - 确定最佳校准策略

---

## 🎓 经验教训

### 教训1：测试方法的重要性

```
❌ 错误方法：猜测哪个命令有问题，逐个注释
✅ 正确方法：系统化组合测试，找出规律
```

**本次测试方法**：

- 12组不同的命令组合
- 覆盖所有关键命令的有无状态
- 发现了明确的错误模式

### 教训2：错误信息的可信度

```
"Antenna geometry is not fully defined" → 准确！
"Failed to start sensor [-203621554]" → 模糊！（实际是校准问题）
```

**启示**：

- 清晰的错误信息（如-1）往往指向明确的缺失配置
- 复杂的错误码（如-203621554）可能涉及多个因素

### 教训3：必需命令 vs 可选命令

```
✅ 必需命令：
  - antGeometryBoard xWRL6844EVM
  - runtimeCalibCfg 1
  
⚠️ 可选命令：
  - factoryCalibCfg（但参数必须正确）
  - adcDataSource（测试用）
  - adcLogging（调试用）
```

---

## 📊 测试数据原始记录

详细的测试日志已保存，包括：

- 每个测试的完整命令序列
- 雷达的响应和错误信息
- 错误码的十六进制和十进制表示

---

> 💡 **下一步行动**：立即修改 radar_control.c，强制跳过工厂校准，使用方案A测试。
