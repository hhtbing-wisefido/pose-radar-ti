# 📝 Phase 3: 固件框架移植开始

**日期**: 2025-12-09  
**时间**: 17:38  
**阶段**: Phase 3 - 固件框架移植  
**状态**: 进行中 🔄

---

## 🎯 本次工作内容

### 1. 源码学习完成

完整学习了 IWRL6432 Pose and Fall Detection 源码：

**源码结构**:
```
Pose_And_Fall_Detection/
├── src/xWRL6432/
│   ├── pose.h          # ML接口定义 (89行)
│   ├── pose.c          # ML推理实现 (125行)
│   ├── motion_detect.c # 主程序 (2032行)
│   └── model/
│       ├── pose_model.a        # TVM编译模型 (64KB)
│       └── tvmgen_default.h    # 模型接口
└── retraining_resources/
    └── pose_and_fall_model_training.ipynb  # 训练脚本
```

**关键发现**:
- 模型输入: 176维 (22特征 × 8帧)
- 模型输出: 5类概率
- 特征组成: 7个运动特征 + 15个点云特征
- 使用 TVM Neural Net Compiler 编译

---

### 2. 固件框架创建

创建了 AWRL6844 固件框架：

```
firmware/
├── common/
│   ├── pose_types.h     # ✅ 类型定义 (200行)
│   └── pose_config.h    # ✅ 平台配置 (130行)
├── mss/
│   ├── pose_mss.h       # ✅ MSS头文件 (200行)
│   └── pose_mss.c       # ✅ MSS实现 (450行)
├── model/
│   └── tvmgen_default.h # ✅ 模型接口 (100行)
└── README.md            # ✅ 文档
```

---

## 📊 代码移植对照

### pose_types.h (新建)

| 定义 | IWRL6432 值 | AWRL6844 值 | 说明 |
|------|-------------|-------------|------|
| `NUM_FRAMES_OF_DATA` | 8 | 8 | 保持一致 |
| `ML_TYPE_HUMANPOSE_CLASSES` | 5 | 5 | 保持一致 |
| `ML_TYPE3_FEATURE_COUNT` | 22 | 22 | 保持一致 |
| `AWRL6844_NUM_RANGE_BINS` | N/A | 128 | 新增 |

### pose_mss.c (移植自 pose.c)

| 函数 | 状态 | 说明 |
|------|------|------|
| `CreateFeatureVector()` | ✅ 已移植 | 特征向量构建 |
| `Inference()` → `MSS_runInference()` | ✅ 已移植 | ML推理 |
| `MSS_extractFeatures()` | ✅ 新增 | 特征提取封装 |
| `MSS_selectMaxHeightPoints()` | ✅ 新增 | 最高点选择 |

---

## 🔧 技术要点

### 1. 架构差异

```
IWRL6432 (单核):
┌─────────────────┐
│   Cortex-M4F    │
│  (全部功能)     │
└─────────────────┘

AWRL6844 (双核):
┌─────────────────┐     ┌─────────────────┐
│   Cortex-R4F    │     │   C674x DSP     │
│   (MSS)         │◄───►│   (DSS)         │
│ - CLI处理       │     │ - Range FFT     │
│ - ML推理        │     │ - CFAR          │
│ - UART输出      │     │ - 点云生成      │
└─────────────────┘     └─────────────────┘
```

### 2. TVM 模型重编译

```bash
# Cortex-M4F → Cortex-R4F
# 编译选项变化:
# -mcpu=cortex-m4    → -mcpu=cortex-r4
# -march=armv7e-m    → -march=armv7-r
# -mfpu=fpv4-sp-d16  → -mfpu=vfpv3-d16
```

### 3. 特征提取流程

```
点云数据 ──► 选择5个最高点 ──► 提取(y,z,snr)
              │
跟踪数据 ──► 提取运动特征 ──► (posz,vel,acc)
              │
              ▼
         22维特征/帧
              │
              ▼
       8帧循环缓冲
              │
              ▼
     176维模型输入
```

---

## ✅ 完成项

- [x] 学习 IWRL6432 源码结构
- [x] 分析 ML 推理流程
- [x] 创建 firmware 目录结构
- [x] 移植 pose_types.h
- [x] 创建 pose_config.h (平台配置)
- [x] 移植 pose_mss.c/h
- [x] 创建 tvmgen_default.h (R4F版本)
- [x] 编写 firmware/README.md

---

## 📋 待完成项 (Phase 3 后续)

### Phase 3.2: SDK 集成
- [ ] 集成 mmWave SDK 6.x 头文件
- [ ] 适配 Range FFT DPU
- [ ] 适配 CFAR 检测器
- [ ] 适配点云生成模块
- [ ] 适配目标跟踪器

### Phase 3.3: 双核通信
- [ ] MSS-DSS IPC 配置
- [ ] 共享内存分配
- [ ] 消息队列实现

### Phase 3.4: 系统集成
- [ ] CCS 项目创建
- [ ] 链接脚本配置
- [ ] 编译验证

---

## 📈 项目进度

```
Phase 1: 项目规划     ████████████████████ 100% ✅
Phase 2: 雷达配置     ████████████████████ 100% ✅
Phase 3: 固件框架     ████████░░░░░░░░░░░░  40% 🔄
Phase 4: AI模型       ░░░░░░░░░░░░░░░░░░░░   0%
Phase 5: 系统集成     ░░░░░░░░░░░░░░░░░░░░   0%
Phase 6: 文档部署     ░░░░░░░░░░░░░░░░░░░░   0%

整体进度: ~25%
```

---

## 📂 创建的文件

| 文件 | 大小 | 说明 |
|------|------|------|
| `firmware/common/pose_types.h` | ~7KB | 类型定义 |
| `firmware/common/pose_config.h` | ~4KB | 平台配置 |
| `firmware/mss/pose_mss.h` | ~5KB | MSS头文件 |
| `firmware/mss/pose_mss.c` | ~13KB | MSS实现 |
| `firmware/model/tvmgen_default.h` | ~3KB | 模型接口 |
| `firmware/README.md` | ~4KB | 固件文档 |

---

## 🔗 参考资源

- [IWRL6432 源码](../../知识库/Pose_And_Fall_Detection/src/xWRL6432/)
- [pose.h](../../知识库/Pose_And_Fall_Detection/src/xWRL6432/pose.h)
- [pose.c](../../知识库/Pose_And_Fall_Detection/src/xWRL6432/pose.c)
- [motion_detect.c](../../知识库/Pose_And_Fall_Detection/src/xWRL6432/motion_detect.c)

---

**下一步**: 集成 mmWave SDK 6.x，适配数据处理链
