# Flash偏移值动态读取优化

## 📋 修改概述

去除Flash偏移值的硬编码，改为从设备配置中动态读取。

## 🔧 修改内容

### 1. 修改 `analyze_appimage_structure()` 函数

**文件**: `flash_tool.py`

**变更**:
- 添加 `device_config` 参数
- 从 `device_config` 中读取 `sbl_offset` 和 `app_offset`
- 如果未提供配置，使用 `DEVICE_CONFIGS['AWRL6844']` 的默认值

**修改前**:
```python
def analyze_appimage_structure(file_path):
    # ...
    FLASH_SBL_OFFSET = 0x2000    # 硬编码
    FLASH_APP_OFFSET = 0x42000   # 硬编码
```

**修改后**:
```python
def analyze_appimage_structure(file_path, device_config=None):
    # ...
    if device_config:
        FLASH_SBL_OFFSET = device_config.get('sbl_offset', 0x2000)
        FLASH_APP_OFFSET = device_config.get('app_offset', 0x42000)
    else:
        FLASH_SBL_OFFSET = DEVICE_CONFIGS['AWRL6844']['sbl_offset']
        FLASH_APP_OFFSET = DEVICE_CONFIGS['AWRL6844']['app_offset']
```

### 2. 更新函数调用

在 `analyze_firmware()` 方法中传入 `self.device_config`:

```python
# SBL分析
info = analyze_appimage_structure(sbl_file, self.device_config)

# App分析
info = analyze_appimage_structure(app_file, self.device_config)
```

## ✅ 验证测试

创建了测试脚本 `test_flash_offset.py`，验证：

1. **默认配置**: 不传 `device_config`，使用 AWRL6844 默认值
   - SBL: 0x2000 ✅
   - App: 0x42000 ✅

2. **设备配置**: 传入 `DEVICE_CONFIGS['AWRL6844']`
   - SBL: 0x2000 ✅
   - App: 0x42000 ✅

3. **自定义配置**: 传入自定义偏移值
   - SBL: 0x3000 ✅
   - App: 0x50000 ✅

## 📈 优势

1. **灵活性**: 支持不同设备的不同偏移值
2. **可维护性**: Flash偏移值统一在 `DEVICE_CONFIGS` 中管理
3. **可扩展性**: 易于支持新的设备型号
4. **向后兼容**: 保留默认行为，不影响现有调用

## 🔗 相关配置

Flash偏移值在 `DEVICE_CONFIGS` 中定义：

```python
DEVICE_CONFIGS = {
    'AWRL6844': {
        'sbl_offset': 0x2000,      # SBL烧录地址（8KB偏移）
        'app_offset': 0x42000,     # 应用固件烧录地址（264KB偏移）
        # ...
    }
}
```

## 📅 修改时间

2025-12-19

## ✍️ 修改人

GitHub Copilot (Claude Sonnet 4.5)
