#
# Auto generated makefile for Multi-Core Boot Image Generation
#
# Variables needed (passed from CCS or command line):
# - MCU_PLUS_SDK_PATH
# - PROFILE (Debug or Release)
# - OUTNAME (health_detect_system)
# - CCS_INSTALL_DIR

CCS_PATH=$(CCS_INSTALL_DIR)
include $(MCU_PLUS_SDK_PATH)/imports.mak

MULTI_CORE_BOOTIMAGE_PATH=$(abspath ${PROFILE})
MULTI_CORE_BOOTIMAGE_NAME:=health_detect_system.$(PROFILE).appimage

CONFIG_PATH:=$(MULTI_CORE_BOOTIMAGE_PATH)/config
TEMP_PATH:=$(MULTI_CORE_BOOTIMAGE_PATH)/temp

#
# Generation of multi-core boot image which can be loaded by Secondary Boot Loader (SBL)
#
ifeq ($(OS),Windows_NT)
EXE_EXT=.exe
endif

META_IMG_GEN_PATH=$(MCU_PLUS_SDK_PATH)/tools/MetaImageGen
ifeq ($(OS),Windows_NT)
META_IMG_GEN=metaImage_creator$(EXE_EXT)
else
META_IMG_GEN=./metaImage_creator$(EXE_EXT)
endif
META_IMG_CONFIG=$(CONFIG_PATH)/metaimage_cfg.$(PROFILE).json

json_content:=$(shell $(CAT) $(MULTI_CORE_BOOTIMAGE_PATH)/../metaimage_cfg.$(PROFILE).json)
new_json_content:=$(subst ../../examples/empty/xwrL684x-evm/system_freertos,$(MULTI_CORE_BOOTIMAGE_PATH),$(json_content))

all:
	@echo .
	@echo Creating multi-core boot image: $(MULTI_CORE_BOOTIMAGE_NAME)
	$(MKDIR) $(TEMP_PATH)
	$(MKDIR) $(CONFIG_PATH)
	@echo $(new_json_content) > $(META_IMG_CONFIG)
	$(COPY) ../../AWRL6844_HealthDetect_MSS/$(PROFILE)/AWRL6844_HealthDetect_MSS.$(PROFILE).rig $(TEMP_PATH)/health_detect_mss_img.$(PROFILE).rig
	$(COPY) ../../AWRL6844_HealthDetect_DSS/$(PROFILE)/AWRL6844_HealthDetect_DSS.$(PROFILE).rig $(TEMP_PATH)/health_detect_dss_img.$(PROFILE).rig
	cd $(META_IMG_GEN_PATH) && $(META_IMG_GEN) --complete_metaimage $(META_IMG_CONFIG)
	$(RMDIR) $(TEMP_PATH)
	@echo .
	@echo Multi-core boot image created: $(MULTI_CORE_BOOTIMAGE_PATH)/$(MULTI_CORE_BOOTIMAGE_NAME)
	@echo Done !!!
	@echo .

clean:
	$(RMDIR) $(MULTI_CORE_BOOTIMAGE_PATH)
