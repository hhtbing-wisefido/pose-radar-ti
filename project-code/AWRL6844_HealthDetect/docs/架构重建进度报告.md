# 🚀 第3章架构重建进度报告

**日期**: 2026-01-07  
**任务**: 根据第3章三层架构完整重建AWRL6844_HealthDetect项目  
**方法**: 参考mmw_demo功能，不复制代码，重写实现

---

## ✅ 已完成部分

### 1. src/common/ - 共享接口层 ✅

| 文件 | 状态 | 说明 |
|-----|------|------|
| `shared_memory.h` | ✅ 完成 | L3 RAM内存映射定义 |
| `data_path.h` | ✅ 完成 | DPC结构定义（学习自mmw_demo dpc.h） |
| `mmwave_output.h` | ✅ 完成 | TLV输出格式（学习自mmw_demo TLV） |
| `health_detect_types.h` | ✅ 已存在 | 特征数据结构 |

**关键内容**：
- ✅ DPC配置结构：`DPC_Config_t`（MSS→DSS）
- ✅ DPC结果结构：`DPC_Result_t`（DSS→MSS）
- ✅ 点云结构：`DPC_PointCloudCartesian_t`
- ✅ TLV格式：`MmwaveOutput_Header_t`、TLV类型定义

### 2. src/system/ - 系统配置层 ✅

| 文件 | 状态 | 说明 |
|-----|------|------|
| `linker_mss.cmd` | ✅ 完成 | MSS链接脚本 |
| `linker_dss.cmd` | ✅ 完成 | DSS链接脚本 |
| `shared_memory.ld` | ✅ 完成 | 内存区域定义 |
| `README.md` | ✅ 完成 | 系统配置文档 |

### 3. src/mss/ - MSS应用层 ✅ 框架完成

| 文件 | 状态 | 说明 |
|-----|------|------|
| `health_detect_main.c/h` | ✅ 框架完成 | 主控制程序（新写，不是mmwave_demo.c） |
| `dpc_control.c/h` | ✅ 框架完成 | DPC协调模块（学习自mmw_demo dpc.c） |
| `cli.c/h` | ✅ 框架完成 | CLI命令处理（学习自mmw_cli.c） |
| `presence_detect.c/h` | ⏳ 待创建 | 存在检测模块 |
| `tlv_output.c/h` | ⏳ 待创建 | TLV输出模块 |
| `radar_control.c/h` | ⏳ 待创建 | 雷达配置模块 |

**health_detect_main.c关键功能**：
- ✅ BIOS任务框架
- ✅ 共享内存映射
- ✅ DPC配置初始化
- ✅ 帧处理循环
- ⚠️ TODO: 雷达mmWave API调用
- ⚠️ TODO: IPC与DSS通信
- ⚠️ TODO: TLV输出

### 4. src/dss/ - DSS算法层 ✅ 已存在

| 文件 | 状态 | 说明 |
|-----|------|------|
| `dss_main.c/h` | ✅ 已存在 | DSP入口点 |
| `feature_extract.c/h` | ✅ 已存在 | 特征提取算法（新功能） |
| `dsp_utils.c/h` | ⏳ 待创建 | DSP工具函数 |

---

## ⏳ 待完成部分

### MSS模块（优先级：高）

1. **presence_detect.c/h** - 存在检测
   - 基于特征数据判断是否有人
   - 状态机：ABSENT → PRESENT → MOTION
   - 输出：PresenceState_e

2. **tlv_output.c/h** - TLV输出
   - 构建TLV数据包
   - UART发送
   - 学习自mmw_demo TLV输出模块

3. **radar_control.c/h** - 雷达控制
   - mmWave API封装
   - 配置chirp参数
   - 帧回调注册
   - 学习自mmw_demo/mmwave_control/

### DSS模块（优先级：中）

4. **dsp_utils.c/h** - DSP工具
   - FFT辅助函数
   - CFAR辅助函数
   - 内存管理

### CCS项目配置（优先级：高）

5. **创建CCS项目文件**
   - 不复制xwrL684x-evm/
   - 创建新的.projectspec
   - 引用src/system/linker_mss.cmd
   - 配置编译选项

---

## 🔥 关键区别：参考 vs 重建

| 方面 | mmw_demo_SDK_reference | AWRL6844_HealthDetect |
|-----|------------------------|------------------------|
| **用途** | ✅ 参考学习 | ✅ 新架构实现 |
| **代码来源** | SDK原始代码 | 重新编写 |
| **架构** | 扁平结构（source/） | 三层结构（common/mss/dss/） |
| **DSS使用** | 0%（全在R5F） | 40%（特征提取） |
| **文件复制** | ❌ 禁止 | ✅ 从零编写 |

**正确做法**：
- ✅ 阅读mmw_demo源码理解功能
- ✅ 学习API调用方式
- ✅ 参考结构体定义
- ✅ 按第3章架构重新实现
- ❌ 不直接复制粘贴代码

---

## 📊 完成度统计

```
总体进度: ████████░░░░░░ 55%

分层统计:
- common/  ████████████████ 100% ✅
- system/  ████████████████ 100% ✅
- mss/     ██████████░░░░░░  60% 🔄
- dss/     ██████████░░░░░░  60% ✅
- CCS项目  ░░░░░░░░░░░░░░░░   0% ⏳
```

### 文件统计
- ✅ 完成：12个文件
- 🔄 框架完成：3个文件
- ⏳ 待创建：6个文件

---

## 🎯 下一步行动计划

### 第1阶段：完成MSS核心模块（优先）

```
1. 创建 presence_detect.c/h
   - 实现存在检测算法
   - 使用feature_extract输出的特征
   
2. 创建 tlv_output.c/h
   - 实现TLV封装
   - UART发送函数
   
3. 创建 radar_control.c/h
   - 封装mmWave API
   - 参考mmw_demo/mmwave_control/
```

### 第2阶段：完成IPC通信（关键）

```
4. 在health_detect_main.c中实现：
   - IPC mailbox初始化
   - MSS→DSS触发消息
   - DSS→MSS完成通知
   
5. 在dss_main.c中实现：
   - Mailbox消息处理
   - DPC执行循环
   - 结果写入L3 RAM
```

### 第3阶段：创建CCS项目（编译验证）

```
6. 创建MSS项目配置
   - .projectspec for MSS
   - 引用src/mss/*.c
   - 链接src/system/linker_mss.cmd
   
7. 创建DSS项目配置
   - .projectspec for DSS
   - 引用src/dss/*.c
   - 链接src/system/linker_dss.cmd
   
8. 验证编译
   - CCS编译0错误
   - 链接成功
   - 生成.out固件
```

---

## ✅ 验收标准

### 代码质量
- [x] 所有文件都是新写的（不是复制mmw_demo）
- [x] 遵循第3章三层架构
- [x] 有清晰的注释说明参考来源
- [ ] 实现了MSS-DSS协作
- [ ] 实现了特征提取（DSS独有）

### 编译验证
- [ ] MSS项目编译通过
- [ ] DSS项目编译通过
- [ ] 链接脚本正确
- [ ] 共享内存配置无冲突

### 功能验证（下一章）
- [ ] 雷达可以启动
- [ ] DPC可以运行
- [ ] 点云数据输出
- [ ] 特征数据输出

---

## 🔄 当前工作状态

**刚完成**：
- ✅ src/common/ 完整定义
- ✅ src/mss/ 核心框架（health_detect_main、dpc_control、cli）

**正在做**：
- 等待用户确认方向

**下一步**：
- 选项1：继续完成MSS剩余模块
- 选项2：先创建CCS项目验证编译
- 选项3：完善DSS IPC通信

---

> 📝 **重要提醒**：这是从零重建，不是复制mmw_demo！
> 
> - mmw_demo_SDK_reference = 参考手册
> - AWRL6844_HealthDetect = 新实现
> - 方法：学习理解 → 重新编写 → 实现同等功能
