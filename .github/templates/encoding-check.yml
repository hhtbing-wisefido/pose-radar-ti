# æ–‡ä»¶ï¼š.github/workflows/encoding-check.yml
# å°†æ­¤æ–‡ä»¶å¤åˆ¶åˆ° .github/workflows/ ç›®å½•
name: ğŸ” Encoding Check
on:
  push:
    branches: [ main, master, develop ]
    paths:
      - '**.html'
      - '**.css'
      - '**.js'
      - '**.jsx'
      - '**.ts'
      - '**.tsx'
      - '**.vue'
      - '**.json'
      - '**.md'
      - '**.yml'
      - '**.yaml'
  pull_request:
    branches: [ main, master ]
jobs:
  encoding-check:
    name: æ£€æŸ¥æ–‡ä»¶ç¼–ç 
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: ğŸ” æ£€æŸ¥ UTF-8 ç¼–ç 
        run: |
          echo "=== æ£€æŸ¥æ–‡ä»¶ç¼–ç  ==="
          python3 << 'EOF'
          import os
          import sys
          errors = []
          warnings = []
          # éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶æ‰©å±•å
          extensions = ('.html', '.css', '.js', '.jsx', '.ts', '.tsx', '.vue', '.json', '.md', '.yml', '.yaml')
          # æ’é™¤çš„ç›®å½•
          exclude_dirs = {'node_modules', '.git', 'vendor', 'dist', 'build', '__pycache__'}
          for root, dirs, files in os.walk('.'):
              # æ’é™¤ç›®å½•
              dirs[:] = [d for d in dirs if d not in exclude_dirs]
              for file in files:
                  if file.endswith(extensions):
                      filepath = os.path.join(root, file)
                      try:
                          # æ£€æŸ¥ UTF-8 ç¼–ç 
                          with open(filepath, 'r', encoding='utf-8') as f:
                              content = f.read()
                          # æ£€æŸ¥ BOM
                          with open(filepath, 'rb') as f:
                              if f.read(3) == b'\xef\xbb\xbf':
                                  warnings.append(f"âš ï¸ {filepath}: åŒ…å« BOM æ ‡è®°")
                          # æ£€æŸ¥ CRLF
                          if '\r\n' in content:
                              warnings.append(f"âš ï¸ {filepath}: ä½¿ç”¨ CRLF æ¢è¡Œç¬¦")
                      except UnicodeDecodeError as e:
                          errors.append(f"âŒ {filepath}: ç¼–ç é”™è¯¯ - {e}")
          # è¾“å‡ºç»“æœ
          if errors:
              print("\n=== ç¼–ç é”™è¯¯ ===")
              for err in errors:
                  print(err)
          if warnings:
              print("\n=== ç¼–ç è­¦å‘Š ===")
              for warn in warnings:
                  print(warn)
          if errors:
              print(f"\nå‘ç° {len(errors)} ä¸ªé”™è¯¯ï¼Œ{len(warnings)} ä¸ªè­¦å‘Š")
              sys.exit(1)
          elif warnings:
              print(f"\nå‘ç° {len(warnings)} ä¸ªè­¦å‘Šï¼ˆéé˜»å¡ï¼‰")
          else:
              print("\nâœ… æ‰€æœ‰æ–‡ä»¶ç¼–ç æ£€æŸ¥é€šè¿‡")
          EOF
      - name: ğŸ”§ è‡ªåŠ¨ä¿®å¤ç¼–ç é—®é¢˜
        if: failure()
        run: |
          echo "=== å°è¯•è‡ªåŠ¨ä¿®å¤ç¼–ç é—®é¢˜ ==="
          python3 << 'EOF'
          import os
          extensions = ('.html', '.css', '.js', '.jsx', '.ts', '.tsx', '.vue', '.json', '.md', '.yml', '.yaml')
          exclude_dirs = {'node_modules', '.git', 'vendor', 'dist', 'build'}
          fixed_count = 0
          for root, dirs, files in os.walk('.'):
              dirs[:] = [d for d in dirs if d not in exclude_dirs]
              for file in files:
                  if file.endswith(extensions):
                      filepath = os.path.join(root, file)
                      try:
                          with open(filepath, 'rb') as f:
                              content = f.read()
                          modified = False
                          # ç§»é™¤ BOM
                          if content.startswith(b'\xef\xbb\xbf'):
                              content = content[3:]
                              modified = True
                          # è½¬æ¢ CRLF ä¸º LF
                          if b'\r\n' in content:
                              content = content.replace(b'\r\n', b'\n')
                              modified = True
                          if modified:
                              with open(filepath, 'wb') as f:
                                  f.write(content)
                              print(f"âœ… å·²ä¿®å¤: {filepath}")
                              fixed_count += 1
                      except Exception as e:
                          print(f"âŒ æ— æ³•å¤„ç†: {filepath} - {e}")
          print(f"\nå…±ä¿®å¤ {fixed_count} ä¸ªæ–‡ä»¶")
          EOF
      - name: ğŸ“ æäº¤ä¿®å¤
        if: failure()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git diff --staged --quiet || git commit -m "chore: è‡ªåŠ¨ä¿®å¤ç¼–ç é—®é¢˜ [skip ci]"
          git push || echo "æ— éœ€æ¨é€"
